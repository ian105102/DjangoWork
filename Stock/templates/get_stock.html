{% extends "base/base.html" %}
{% load static %}
{% block hend %}
<link rel="stylesheet" type="text/css" href="{%static 'css/styles_get_stock.css' %}" >
{% endblock hend %}
{% block mainBody %}
<div class="content">
	{% if error_message != None %}
		<h1 style="text-align: center;">查無此股票</h1>
		<img class="image404" src="{% static 'image/404.gif' %}" alt="404" class="img_404">
		<div class="nothing" ></div>
	{% else %}
	<div class="stock_title">
		<h2 class="fullname">{{Data.fullname}}</h2>
		<br>
		<h3 class="stock_name">{{Data.name}}</h3>
		<h3 class="stock_symbol">{{Data.stock_symbol}}</h3>
		<h3 class="time">{{Data.time}}</h3>
	</div>
	
	<div class="stock_table floatHeader" >
		<table>
			<thead>
				<tr>
				  <th class="title1" scope="col"  colspan="2">基礎資訊</th>
				  <th class="title2" scope="col" colspan="6">四大買賣點</th>
				</tr>
			  </thead>
			<tbody>
				<tr>
					<th scope="row"> 開盤價</th>
					<td>{{Data.open}}</td>
					<th scope="row">最佳買入價(best bid price)</th>
					{% for i in Data.best_bit_price %}
					<td>{{ i }}</td>
					{% endfor %}
				</tr>
				<tr>
					<th scope="row">最高價</th>
					<td>{{Data.high}}</td>
					<th scope="row">最佳買入數量(best bid volume)</th>
					{% for i in Data.best_bit_volume %}
					<td>{{ i }}</td>
					{% endfor %}
				</tr>
				<tr>
					<th scope="row">最低價</th>
					<td>{{Data.low}}</td>
					<th scope="row">最佳賣出價(best ask price)</th>
					{% for i in Data.best_ask_price %}
					<td>{{ i }}</td>
					{% endfor %}
				</tr>
				<tr>
					<th scope="row"></th>
					<td></td>
					<th scope="row">	最佳賣出數量(best ask volume)</th>
					{% for i in Data.best_ask_volume %}
					<td>{{ i }}</td>
					{% endfor %}
				</tr>
			</tbody>
		</table>
</div>
	{% if Data.stock_back%}
	<div class="chart " >
		<label for="formGroupExampleInput" class="form-label">輸入圖表類型</label>
		<select class="form-select select_len" aria-label="Default select example">
			<option value="0">請選擇圖表</option>
			<option value="1">年表</option>
			<option value="2">月表</option>
		</select>

		<div class="_year_select">
		</div>
		<div class="_month_select">
		</div>
	</div>
	{% comment %} <div id="container"></div> {% endcomment %}
	<div id="chart_image"></div>
	{% endif %}
	{% endif %}
	
</div>
{% endblock mainBody %}



{% block script %}
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/klinecharts/dist/klinecharts.min.js"></script>


	<script type="text/javascript" src="{%static 'js/vanilla-tilt.js' %}"></script>
	<script type="text/javascript" src="{%static 'js/tilt_.js' %}"></script>


	{% if error_message == None %}
	<script>
		const all_month = {{ Data.all_month|safe }};
	</script>
	<script>
		let data;
		fetch(url_ + 'Stock/get_chart/?stock_symbol=' + stock_symbol)
		.then(response => response.json())
		.then(data_ => {
			// 在控製臺輸出獲取到的資料
			data = data_;
	
			showChart(data)
			// 在這裡可以執行你想要做的操作，例如更新網頁上的圖表或顯示資料
		})
		


		function fetchHistoricalData(chartType, year, month) {
			const stockSymbol = "{{ Data.stock_symbol }}";

			let url = url_ + 'Stock/get_chart/?stock_symbol=' + stock_symbol
			if (chartType === 1) {
				url += `&year=${year}`;
			} else if(chartType === 2) {
				url += `&year=${year}&month=${month}`;
			}

			fetch(url)
				.then(response => response.json())
				.then(data => {
					// Process and display the chart data here
					showChart(data);

				});
		}

		var kdj = null;
		var candle_pane = null;

		// 圖表
		function showChart(data) {
			document.getElementById('chart_image').style.height = '800px';
			document.getElementById('chart_image').style.width = '100%';


			let element = document.getElementById("chart_image");
			while (element.firstChild) {
				element.removeChild(element.firstChild);
			}

			var new_chart = document.createElement("div");
			new_chart.id = "chart_image_show";
			new_chart.style.height = '800px';
			//     new_chart.style.height = '80%' ;
			element.appendChild(new_chart);
			// 初始化
			var chart = klinecharts.init('chart_image_show')
			// 移除
			if (candle_pane != null)
				chart.removeIndicator(candle_pane);
			if (kdj != null)
				chart.removeIndicator(kdj);
			// 建主要K線
			candle_pane = chart.createIndicator('MA', false, {id: 'candle_pane'})

			// 建 KD
			kdj = chart.createIndicator('KDJ', "KDJ")
			// 載數據
			let chartDataList = Object.values(data);

			chart.applyNewData(chartDataList);
		
		}
	</script>

	<script src="{%static 'js/select_get_stock.js' %}"></script>


	{% endif %}
{% endblock script %}
